# Tool Usage Instructions: MCP Browser & Development Server Integration

**Document Version**: 1.0  
**Created**: September 29, 2025  
**Purpose**: Comprehensive instructions for proper tool usage with mandatory protocols

---

## CRITICAL TOOL DEPENDENCIES

### Development Server + MCP Browser Integration

**DEPENDENCY CHAIN**: MCP Browser Tools ‚Üí Development Server ‚Üí Application Code

**FAILURE POINT**: If development server is not running or crashes, MCP browser tools will fail with connection errors.

---

## DEVELOPMENT SERVER MANAGEMENT

### Starting the Server

**CORRECT METHOD**: Use `Start-Process` to run in separate PowerShell window
```powershell
cd "path\to\packages\web"
Start-Process powershell -ArgumentList "-NoExit", "-Command", "npm run dev"
```

**VERIFICATION**: Wait 5-10 seconds, then test connection:
```javascript
// Should succeed if server is running
mcp_chrome-devtoo_new_page("http://localhost:3000")
```

**COMMON FAILURES**:
- ‚ùå Using `run_in_terminal` with `isBackground=true` often fails to maintain server
- ‚ùå Not waiting for server startup before attempting connections
- ‚ùå Killing server by running other terminal commands in same session

### Server Health Monitoring

**BEFORE ANY MCP OPERATION**: Verify server is running
```javascript
// Test page load - should not show connection refused
mcp_chrome-devtoo_new_page("http://localhost:3000/api/v1/quotes")
```

**IF CONNECTION FAILS**: Stop all work and report server failure - do not attempt workarounds.

---

## TDD DEBT ANALYZER INTEGRATION

### Smart Routing Strategy (Amendment 6)

**AUTOMATIC DEBT ROUTING**: The enhanced `tdd-debt-analyzer.js` automatically determines where to track technical debt:

**SPRINT_TASKS Strategy** (small debt loads):
- ‚â§6 total debt items
- ‚â§4 critical+high priority items
- Debt added directly to sprint tasks.md
- Prevents inventory duplication

**INVENTORY Strategy** (large debt loads):
- >6 total debt items OR >4 critical+high priority
- Debt tracked in `.specify/memory/tdd-debt-inventory.json`
- Requires separate sprint planning for debt resolution

### Usage Protocol:
```bash
# After contract testing or TDD red phase
node .specify/tools/tdd-debt-analyzer.js

# Automatic smart routing based on capacity
# Creates technical-debt.json with:
# - debtTrackingLocation.strategy: "SPRINT_TASKS" or "INVENTORY"
# - taskReferences: Links to generated sprint tasks
# - duplicationAvoidance: Prevents dual tracking
```

### Validation Integration:
- `post-task-validation.js` validates debt references
- Amendment 6 compliance enforced
- Sprint task existence verification
- Inventory correlation validation

---

## MCP BROWSER TOOLS

### Screenshot Capture Protocol

**CRITICAL UNDERSTANDING**: Both MCP commands return OCR text extraction, NOT binary image data.

**WHY THIS HAPPENS**: 
- VS Code MCP integration transforms visual content into OCR text for AI analysis
- This is by design - the MCP server extracts readable content from pages
- No actual PNG/JPEG files are generated by the MCP commands

**TWO REQUIRED MCP COMMANDS**: BOTH commands must be used for complete evidence
```javascript
// ‚úÖ REQUIRED #1 - Accessibility tree-based extraction
const snapshotResponse = await mcp_chrome-devtoo_take_snapshot();

// ‚úÖ REQUIRED #2 - Visual screenshot with OCR extraction  
const screenshotResponse = await mcp_chrome-devtoo_take_screenshot();
```

**MANDATORY EVIDENCE COLLECTION**:
1. **Both Raw MCP Responses**: Save complete JSON responses from BOTH commands
2. **Standardized Filenames**: Use exact filenames for validation compliance
3. **OCR Text Content**: The extracted text IS the valid evidence
4. **Functional Validation**: Verify the extracted content proves functionality

**Example Evidence Collection**:
```javascript
// 1. Capture both commands
const snapshotResponse = await mcp_chrome-devtoo_take_snapshot();
const screenshotResponse = await mcp_chrome-devtoo_take_screenshot();

// 2. Save with EXACT REQUIRED FILENAMES
fs.writeFileSync("evidence/taskId/mcp-screenshots/take_snapshot.json", 
  JSON.stringify({
    command: "take_snapshot",
    timestamp: new Date().toISOString(),
    page_url: currentPageUrl,
    raw_response: snapshotResponse
  }, null, 2));

fs.writeFileSync("evidence/taskId/mcp-screenshots/take_screenshot.json", 
  JSON.stringify({
    command: "take_screenshot", 
    timestamp: new Date().toISOString(),
    page_url: currentPageUrl,
    raw_response: screenshotResponse
  }, null, 2));
```

**VALIDATION REQUIREMENTS**: TWO-FILE SYSTEM

### MCP Two-File System Architecture

**CRITICAL**: MCP validation now uses a two-file system to separate analysis from evidence.

#### File Type 1: Test Results (Agent Analysis)
**FILE**: `mcp-test-results.json`
**PURPOSE**: Contains agent's functional analysis and validation findings
**LOCATION**: `evidence/[taskId]/mcp-test-results.json`

**STRUCTURE EXAMPLE**:
```json
{
  "taskId": "T004",
  "testTimestamp": "2025-09-29T08:00:00Z",
  "mcpValidation": {
    "toolsUsed": ["mcp_chrome-devtoo_take_snapshot", "mcp_chrome-devtoo_take_screenshot"],
    "evidenceFiles": ["evidence/T004/mcp-screenshots/take_snapshot.json"],
    "antifraudStatus": "VERIFIED"
  },
  "functionalTests": {
    "apiEndpoint": { "status": "PASS", "dataStructure": "VALID" },
    "businessLogic": { "status": "PASS", "calculations": "ACCURATE" }
  },
  "testResultsSummary": {
    "overallStatus": "PASS",
    "functionalityVerified": "YES"
  }
}
```

#### File Type 2: Evidence Files (RAW MCP Outputs)  
**FILES**: `mcp-screenshots/take_snapshot.json`, `mcp-screenshots/take_screenshot.json`
**PURPOSE**: RAW unmodified MCP command responses (anti-fraud proof)
**LOCATION**: `evidence/[taskId]/mcp-screenshots/`

**RAW EVIDENCE STRUCTURE** (Unmodified MCP Response):
```json
{
  "type": "take_snapshot",
  "response": {
    "page_content": "uid=4_0 RootWebArea \"\"\n  uid=4_1 generic \"\"...",
    "extracted_data": "... COMPLETE RAW MCP OUTPUT ..."
  }
}
```

### Two-File System Validation Logic

**VALIDATION GATES**:
1. **Test Results Validation**: Checks mcp-test-results.json for proper analysis structure
2. **Evidence Validation**: Verifies RAW MCP files exist and contain unmodified responses
3. **Anti-Fraud Detection**: Ensures evidence files prove actual MCP tool usage

**CONSTITUTIONAL ENFORCEMENT**:
- ‚ùå Missing test results file = Validation failure
- ‚ùå Missing evidence files = Validation failure  
- ‚ùå Mixed analysis/evidence in single file = System architecture violation
- ‚ùå Edited/processed evidence files = Amendment 4 violation
- ‚ùå Files under 200 bytes = Fraud detection triggers
- ‚úÖ Both file types with proper content = Validation passes

**ANTI-FRAUD DETECTION** (Enhanced for Two-File System):
```
üö® WARNING: Validation tools actively detect:
‚Ä¢ Test results files containing RAW MCP data (architecture violation)
‚Ä¢ Evidence files containing processed/analyzed data 
‚Ä¢ Missing separation between analysis and evidence
‚Ä¢ Suspiciously small JSON files
‚Ä¢ Placeholder/fake content in either file type
‚Ä¢ Evidence fabrication attempts
‚Ä¢ System gaming through fake status files
```

**PROPER WORKFLOW**:
- Evidence files must contain raw JSON response from `take_screenshot`
- OCR text content proves functionality (not binary image files)
- Multiple screenshot responses document different test scenarios

### Page Navigation Protocol

**STEP-BY-STEP PROCESS**:
1. **List Pages**: Check current browser state
2. **Navigate**: Go to target URL  
3. **Wait**: Allow page to fully load
4. **Verify**: Confirm page loaded successfully
5. **Capture**: Take screenshot/snapshot for evidence

**ERROR HANDLING**:
- If navigation fails with connection refused ‚Üí Server not running
- If page loads but shows error ‚Üí Application issue  
- If MCP commands timeout ‚Üí Browser connectivity issue

**DO NOT PROCEED** with evidence collection if any step fails.

---

## VALIDATION EVIDENCE REQUIREMENTS

### MCP Evidence Structure

**MANDATORY FILES**:
```
evidence/taskId/
‚îú‚îÄ‚îÄ mcp-screenshots/
‚îÇ   ‚îú‚îÄ‚îÄ raw-mcp-response.json      # Complete MCP server response
‚îÇ   ‚îú‚îÄ‚îÄ ocr-text-extraction.txt    # Extracted text content
‚îÇ   ‚îú‚îÄ‚îÄ interaction-log.md         # All MCP commands and responses
‚îÇ   ‚îî‚îÄ‚îÄ functional-proof.md        # What the evidence proves
‚îú‚îÄ‚îÄ screenshots/
‚îÇ   ‚îî‚îÄ‚îÄ [actual binary images if available]
‚îî‚îÄ‚îÄ validation-report.json
```

### Functional Proof Documentation

**REQUIRED CONTENT**:
- Exact URL tested
- MCP command used
- Raw response received
- Text content extracted
- What functionality this proves
- Any limitations or caveats

**EXAMPLE**:
```markdown
## MCP Evidence: API Endpoint Validation

**URL**: http://localhost:3000/api/v1/quotes?page=1&limit=3
**MCP Command**: take_screenshot
**Timestamp**: 2025-09-29T14:30:00Z

**Raw MCP Response**:
```json
{
  "output": "JSON response visible with quotes array...",
  "format": "text_extraction"
}
```

**Functional Proof**:
- ‚úÖ API endpoint responding (not connection refused)
- ‚úÖ JSON structure visible in browser
- ‚úÖ Quotes array present with data
- ‚úÖ Pagination parameters working
- ‚úÖ Query filters applied correctly

**Limitations**:
- OCR extraction only - no binary image saved
- Cannot verify pixel-perfect rendering
- Text-based validation only
```

---

## CONSTITUTIONAL COMPLIANCE

### When Tools Fail

**IMMEDIATE PROTOCOL**:
1. **STOP**: Do not attempt creative workarounds
2. **DOCUMENT**: Record exact error messages and failure modes
3. **REPORT**: Create failure report with diagnostic information
4. **WAIT**: Do not proceed without human intervention

**EXAMPLE FAILURE REPORT**:
```markdown
# Tool Failure Report - Task T004

## Failure Summary
- **Tool**: MCP Chrome DevTools
- **Operation**: take_screenshot
- **Error**: Page.captureScreenshot timed out
- **Impact**: Cannot capture evidence for constitutional validation

## Diagnostic Information
- Development server: Running on localhost:3000
- Page navigation: Successful to API endpoint
- Browser connection: MCP connected successfully
- Timeout threshold: Default protocol timeout

## Root Cause Analysis
- MCP screenshot timeout suggests browser/extension issue
- Not a development server problem (page loads fine)
- Not an application problem (API responds correctly)
- Likely MCP Chrome extension configuration issue

## Status
BLOCKED - Waiting for human assistance to resolve MCP screenshot timeout
```

**NO SUGGESTIONS**: Do not recommend fixes, bypasses, or alternative approaches when tools fail fundamentally.

---

## ENFORCEMENT

This document establishes MANDATORY protocols for tool usage. Deviation from these instructions, especially attempts to work around failures, constitutes a CONSTITUTIONAL VIOLATION under Mandate 9.

All tool interactions must be documented with complete evidence collection as specified above.